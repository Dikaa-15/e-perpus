<!-- Hero Section with Library Background -->
<div class="relative bg-gradient-to-r from-blue-800 to-blue-600 text-white py-20 mb-12 rounded-lg shadow-xl overflow-hidden">
    <div class="absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cg fill=\"%23ffffff\" fill-opacity=\"0.1\" fill-rule=\"evenodd\"%3E%3Ccircle cx=\"3\" cy=\"3\" r=\"3\"/%3E%3Ccircle cx=\"13\" cy=\"13\" r=\"3\"/%3E%3C/g%3E%3C/svg%3E')] opacity-20"></div>
    <div class="container mx-auto px-6">
        <div class="text-center relative z-10">
            <h1 class="text-5xl md:text-5xl font-bold mb-8 animate-fade-in">Perpustakaan SMKJP1</h1>
            
            <!-- Glassmorphism Typing Animation -->
            <div class="glassmorphism-hero max-w-2xl mx-auto p-6 rounded-xl backdrop-blur-md bg-white/10 border border-white/20 mb-10">
                <div id="typing-text" class="text-xl md:text-2xl text-blue-100 font-light h-8 min-h-[2rem] flex items-center justify-center"></div>
            </div>
            
            <% if (!user) { %>
                <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                    <a href="/auth/register" class="bg-white text-blue-800 hover:bg-blue-50 px-8 py-4 rounded-lg font-semibold transition-all duration-300 inline-block hover:shadow-lg transform hover:-translate-y-1">
                        <i class="fas fa-user-plus mr-2"></i> Daftar Sekarang
                    </a>
                    <a href="/auth/login" class="border-2 border-white text-white hover:bg-white hover:text-blue-800 px-8 py-4 rounded-lg font-semibold transition-all duration-300 inline-block hover:shadow-lg transform hover:-translate-y-1">
                        <i class="fas fa-sign-in-alt mr-2"></i> Masuk
                    </a>
                </div>
            <% } else { %>
                <div class="glassmorphism-welcome max-w-lg mx-auto p-8 rounded-xl backdrop-blur-md bg-white/10 border border-white/20">
                    <div class="flex items-center justify-center space-x-4">
                        <div class="bg-white/20 rounded-full py-1 px-2">
                            <i class="fas fa-user-circle text-2xl text-white"></i>
                        </div>
                        <div class="text-left">
                            <p class="text-lg text-blue-100">Selamat datang kembali,</p>
                            <p class="text-2xl font-semibold text-white"><%= user.name %></p>
                        </div>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
</div>

<!-- Quick Stats with Book-themed Design -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-16 pt-14 pb-16">
    <div class="bg-gradient-to-br from-blue-50 to-white rounded-xl shadow-lg p-8 border-l-8 border-blue-600 transition-all duration-300">
        <div class="flex items-center">
            <div class="bg-blue-100 w-20 h-20 rounded-lg flex items-center justify-center shadow-inner">
                <i class="fas fa-book-open text-3xl text-blue-600"></i>
            </div>
            <div class="ml-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Total Buku</h3>
                <p class="text-4xl font-bold text-blue-600"><%= stats.totalBooks %></p>
            </div>
        </div>
    </div>
    
    <div class="bg-gradient-to-br from-blue-50 to-white rounded-xl shadow-lg p-8 border-l-8 border-blue-600 transition-all duration-300">
        <div class="flex items-center">
            <div class="bg-blue-100 w-20 h-20 rounded-lg flex items-center justify-center shadow-inner">
                <i class="fas fa-th-large text-3xl text-blue-600"></i>
            </div>
            <div class="ml-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Kategori</h3>
                <p class="text-4xl font-bold text-blue-600"><%= stats.totalCategories %></p>
            </div>
        </div>
    </div>
</div>

    <!-- Category Navigation Tabs -->
    <div class="mb-6 text-center mx-auto">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center justify-center">
            <span class="bg-blue-100 w-12 h-12 rounded-lg flex items-center justify-center mr-4">
                <i class="fas fa-th-large text-blue-600"></i>
            </span>
            Kategori Buku
        </h2>
        
        <div class="bg-white rounded-xl shadow-lg overflow-hidden px-6 py-4 space-y-4">
            <input type="text" id="searchInput" placeholder="Search by book name or author..." 
                   class="w-full max-w-xs mx-auto border border-gray-300 rounded-lg px-4 py-3 text-gray-700 hover:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600 transition-all duration-300" />
            <select id="categorySelect" class="w-full max-w-xs mx-auto border border-gray-300 rounded-lg px-4 py-3 text-gray-700 hover:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600 transition-all duration-300" onchange="filterBooks()">
                <option value="all" selected><i class="fas fa-books"></i> Semua</option>
                <% if (categories && categories.length > 0) { %>
                    <% categories.forEach(category => { 
                        const iconClass = {
                            'fiction': 'fas fa-book',
                            'non-fiction': 'fas fa-book-open',
                            'science': 'fas fa-flask',
                            'technology': 'fas fa-laptop-code',
                            'history': 'fas fa-history',
                            'biography': 'fas fa-user',
                            'mathematics': 'fas fa-calculator',
                            'literature': 'fas fa-feather-alt'
                        }[category.slug] || 'fas fa-book';
                    %>
                        <option value="<%= category.slug %>"><%= category.name %></option>
                    <% }); %>
                <% } %>
            </select>
        </div>
    </div>

<!-- Featured Books Section -->
<div class="mb-28">
    <div id="booksContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <% if (featuredBooks && featuredBooks.length > 0) { %>
            <% featuredBooks.forEach(book => { %>
                <div class="book-card" data-category="<%= book.category_name?.toLowerCase()?.replace(/\s+/g, '-') || 'uncategorized' %>">
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden transition-all duration-300">
                        <div class="h-48 bg-blue-100 relative">
                            <% if (book.cover) { %>
                                <img src="<%= book.cover %>" alt="<%= book.name %>" class="w-full h-full object-cover">
                            <% } else { %>
                                <div class="w-full h-full flex items-center justify-center">
                                    <i class="fas fa-book text-5xl text-blue-300"></i>
                                </div>
                            <% } %>
                            <% if (book.is_popular) { %>
                                <div class="absolute top-2 right-2 bg-yellow-400 text-yellow-900 px-2 py-1 rounded-full text-xs font-semibold">
                                    <i class="fas fa-star mr-1"></i> Popular
                                </div>
                            <% } %>
                            <% if (user) { %>
                                <button data-book-id="<%= book.id %>" 
                                        class="favorite-btn absolute top-2 left-2 hover:text-red-500 focus:outline-none z-10"
                                        title="Toggle Favorite">
                                    <i class="fas fa-heart <%= book.is_favorited ? 'text-red-500' : 'text-gray-400' %>"></i>
                                </button>
                            <% } %>
                        </div>
                        <div class="p-6">
                            <div class="text-xs text-blue-600 font-semibold mb-2"><%= book.category_name || 'Uncategorized' %></div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2"><%= book.name %></h3>
                            <p class="text-gray-600 text-sm mb-2"><%= book.author || 'Unknown Author' %></p>
                            <div class="flex justify-between items-center mt-4">
                                <span class="text-sm text-gray-500"><%= book.year_publisher || '' %></span>
                                <span class="px-2 py-1 rounded-full text-xs <%= book.is_available ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                                    <%= book.is_available ? 'Available' : 'Not Available' %>
                                </span>
                            </div>
                            <% if (user && book.is_available) { %>
                                <button data-book-id="<%= book.id %>" 
                                        data-book-title="<%= book.name %>"
                                        class="borrow-btn w-full mt-4 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300">
                                    <i class="fas fa-book-reader mr-2"></i> Pinjam Buku
                                </button>
                            <% } else if (!user && book.is_available) { %>
                                <a href="/auth/login" class="block text-center w-full mt-4 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300">
                                    <i class="fas fa-sign-in-alt mr-2"></i> Login untuk Meminjam
                                </a>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% }); %>
        <% } else { %>
            <div class="col-span-4 text-center py-8">
                <div class="text-gray-500">No books available at the moment.</div>
            </div>
        <% } %>
    </div>
</div>

<!-- Articles Section -->
<div class="mb-16">
    <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center justify-center">
        <span class="bg-blue-100 w-12 h-12 rounded-lg flex items-center justify-center mr-4">
            <i class="fas fa-newspaper text-blue-600"></i>
        </span>
        Artikel Terbaru
    </h2>

    <!-- Article Filter UI -->
    <div class="mb-6 text-center mx-auto max-w-md">
        <input type="text" id="articleSearchInput" placeholder="Search articles by title..." 
               class="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-700 hover:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600 transition-all duration-300 mb-4" />
        <select id="articleCategorySelect" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-700 hover:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600 transition-all duration-300">
            <option value="all" selected>Semua Kategori</option>
            <% if (categories && categories.length > 0) { %>
                <% categories.forEach(category => { %>
                    <option value="<%= category.slug %>"><%= category.name %></option>
                <% }); %>
            <% } %>
        </select>
    </div>

    <div id="articlesContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <% if (latestArticles && latestArticles.length > 0) { %>
            <% latestArticles.forEach(article => { %>
                <div class="bg-white rounded-lg shadow-lg overflow-hidden transition-all duration-300">
                    <div class="h-48 bg-blue-100 relative">
                        <% if (article.cover) { %>
                            <img src="<%= article.cover %>" alt="<%= article.title %>" class="w-full h-full object-cover">
                        <% } else { %>
                            <div class="w-full h-full flex items-center justify-center">
                                <i class="fas fa-newspaper text-5xl text-blue-300"></i>
                            </div>
                        <% } %>
                    </div>
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2"><%= article.title %></h3>
                        <p class="text-gray-600 text-sm mb-2"><%= article.excerpt %>...</p>
                        <a href="/articles/<%= article.id %>" class="text-blue-600 hover:underline font-semibold">Baca Selengkapnya</a>
                    </div>
                </div>
            <% }); %>
        <% } else { %>
            <div class="col-span-3 text-center py-8">
                <div class="text-gray-500">Tidak ada artikel tersedia saat ini.</div>
            </div>
        <% } %>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Article filtering function
    async function fetchAndRenderArticles() {
        const categorySelect = document.getElementById('articleCategorySelect');
        const searchInput = document.getElementById('articleSearchInput');
        const selectedCategory = categorySelect ? categorySelect.value : 'all';
        const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';

        try {
            const response = await fetch('/api/articles/filter?category=' + encodeURIComponent(selectedCategory) + '&search=' + encodeURIComponent(searchTerm));
            const data = await response.json();
            if (data.success) {
                const articles = data.articles;
                const articlesContainer = document.getElementById('articlesContainer');
                articlesContainer.innerHTML = '';

                if (articles.length === 0) {
                    articlesContainer.innerHTML = '<div class="col-span-3 text-center py-8"><div class="text-gray-500">Tidak ada artikel tersedia saat ini.</div></div>';
                    return;
                }

                articles.forEach(function(article) {
                    var cover = article.cover ? article.cover : '';
                    var articleCard = document.createElement('div');
                    articleCard.className = 'bg-white rounded-lg shadow-lg overflow-hidden transition-all duration-300';
                    var coverHtml = '';
                    if (cover) {
                        coverHtml = '<img src="' + cover + '" alt="' + article.title + '" class="w-full h-full object-cover">';
                    } else {
                        coverHtml = '<div class="w-full h-full flex items-center justify-center"><i class="fas fa-newspaper text-5xl text-blue-300"></i></div>';
                    }
                    articleCard.innerHTML = '<div class="h-48 bg-blue-100 relative">' + coverHtml + '</div>' +
                        '<div class="p-6">' +
                        '<h3 class="text-lg font-semibold text-gray-800 mb-2">' + article.title + '</h3>' +
                        '<p class="text-gray-600 text-sm mb-2">' + article.excerpt + '...</p>' +
                        '<a href="/articles/' + article.id + '" class="text-blue-600 hover:underline font-semibold">Baca Selengkapnya</a>' +
                        '</div>';
                    articlesContainer.appendChild(articleCard);
                });
            } else {
                console.error('Failed to fetch articles');
            }
        } catch (error) {
            console.error('Error fetching articles:', error);
        }
    }

    // Attach event listeners for article filter inputs
    var articleCategorySelect = document.getElementById('articleCategorySelect');
    var articleSearchInput = document.getElementById('articleSearchInput');
    if (articleCategorySelect) {
        articleCategorySelect.addEventListener('change', fetchAndRenderArticles);
    }
    if (articleSearchInput) {
        articleSearchInput.addEventListener('input', fetchAndRenderArticles);
    }
});
</script>

<!-- Library Services -->
<div class="bg-gradient-to-br from-blue-50 via-white to-blue-50 rounded-xl shadow-xl p-12 mb-12">
    <h2 class="text-3xl font-bold text-gray-800 text-center mb-12 flex items-center justify-center">
        <span class="bg-blue-100 w-12 h-12 rounded-lg flex items-center justify-center mr-4">
            <i class="fas fa-concierge-bell text-blue-600"></i>
        </span>
        Layanan Perpustakaan
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        <div class="bg-white p-6 rounded-xl shadow-lg text-center transform hover:scale-105 transition-all duration-300">
            <div class="bg-blue-100 w-16 h-16 rounded-lg flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-book-reader text-2xl text-blue-600"></i>
            </div>
            <h3 class="font-semibold text-gray-800 mb-3">Peminjaman Digital</h3>
            <p class="text-gray-600">Pinjam dan baca buku secara digital kapan saja</p>
        </div>
        
        <div class="bg-white p-6 rounded-xl shadow-lg text-center transform hover:scale-105 transition-all duration-300">
            <div class="bg-blue-100 w-16 h-16 rounded-lg flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-bookmark text-2xl text-blue-600"></i>
            </div>
            <h3 class="font-semibold text-gray-800 mb-3">Bookmark</h3>
            <p class="text-gray-600">Simpan dan tandai buku favorit Anda</p>
        </div>
        
        <div class="bg-white p-6 rounded-xl shadow-lg text-center transform hover:scale-105 transition-all duration-300">
            <div class="bg-blue-100 w-16 h-16 rounded-lg flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-history text-2xl text-blue-600"></i>
            </div>
            <h3 class="font-semibold text-gray-800 mb-3">Riwayat Bacaan</h3>
            <p class="text-gray-600">Pantau aktivitas membaca Anda</p>
        </div>
    </div>
</div>

<!-- Borrow Modal -->
<div id="borrowModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-lg w-full mx-4 transform transition-all max-h-[90vh] overflow-y-auto">
        <div class="text-center mb-6">
            <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-book-reader text-2xl text-blue-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Form Peminjaman Buku</h3>
            <p id="bookTitle" class="text-gray-600 font-semibold"></p>
        </div>
        
        <form id="borrowForm" class="space-y-4">
            <input type="hidden" id="bookId" name="book_id">
            
            <div>
                <label for="loansDate" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-calendar-alt mr-2 text-blue-600"></i>Tanggal Peminjaman
                </label>
                <input type="date" id="loansDate" name="loans_date" 
                       class="w-full px-4 py-3 border-2 border-blue-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300"
                       required>
            </div>
            
            <div>
                <label for="loanDuration" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-clock mr-2 text-blue-600"></i>Durasi Peminjaman
                </label>
<input type="number" id="loanDuration" name="loan_duration" min="1" placeholder="Masukkan durasi peminjaman (hari)" 
       class="w-full px-4 py-3 border-2 border-blue-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300"
       required />
            </div>
            
            <div>
                <label for="dueDate" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-calendar-check mr-2 text-blue-600"></i>Tanggal Jatuh Tempo
                </label>
                <input type="date" id="dueDate" name="due_date" 
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg bg-gray-50 cursor-not-allowed"
                       readonly>
                <p class="text-xs text-gray-500 mt-1">Otomatis dihitung berdasarkan tanggal peminjaman dan durasi</p>
            </div>
            
            <div>
                <label for="borrowPurpose" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-sticky-note mr-2 text-blue-600"></i>Tujuan Peminjaman (Opsional)
                </label>
                <textarea id="borrowPurpose" name="purpose" rows="3"
                          class="w-full px-4 py-3 border-2 border-blue-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300 resize-none"
                          placeholder="Contoh: Untuk tugas kuliah, penelitian, bacaan pribadi, dll."></textarea>
            </div>
            
            <div class="bg-blue-50 p-4 rounded-lg">
                <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>Syarat dan Ketentuan
                </h4>
                <ul class="text-sm text-gray-600 space-y-1">
                    <li>• Buku harus dikembalikan sesuai tanggal jatuh tempo</li>
                    <li>• Denda keterlambatan Rp 1.000 per hari</li>
                    <li>• Maksimal peminjaman 5 buku per anggota</li>
                    <li>• Buku yang rusak/hilang akan dikenakan denda penggantian</li>
                </ul>
                <div class="mt-3">
                    <label class="flex items-center">
                        <input type="checkbox" id="agreeTerms" required 
                               class="w-4 h-4 text-blue-600 border-2 border-gray-300 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Saya setuju dengan syarat dan ketentuan di atas</span>
                    </label>
                </div>
            </div>
            
            <div class="flex gap-4 pt-4">
                <button type="button" onclick="closeBorrowModal()" 
                        class="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-300">
                    <i class="fas fa-times mr-2"></i>Batal
                </button>
                <button type="submit" 
                        class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-300">
                    <i class="fas fa-book-reader mr-2"></i>Pinjam Buku
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Success/Error Messages -->
<div id="messageContainer" class="fixed top-4 right-4 z-50"></div>

<style>
@keyframes fade-in {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
    animation: fade-in 1s ease-out;
}

.glassmorphism-hero {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    animation: glassmorphism-float 3s ease-in-out infinite;
}

.glassmorphism-welcome {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    animation: glassmorphism-float 3s ease-in-out infinite;
}

@keyframes glassmorphism-float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

@keyframes cursor-blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
}

.cursor::after {
    content: '|';
    animation: cursor-blink 1s infinite;
    margin-left: 2px;
    color: #dbeafe;
}

.category-tab.active {
    color: #2563eb;
    border-bottom-color: #2563eb;
}

.book-card {
    transition: all 0.3s ease;
}

.book-card.hidden {
    display: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Typing animation
    const typingText = document.getElementById('typing-text');
    const messages = [
        'Selamat Datang di Perpustakaan Digital SMK Jakarta Pusat 1',
        'Jelajahi Dunia Pengetahuan Melalui Koleksi Digital Kami',
        'Temukan Ribuan Buku dan Artikel Menarik',
        'Baca Dimana Saja, Kapan Saja'
    ];

    function typeWriter(element, text, i, callback) {
        if (i < text.length) {
            element.classList.add('cursor');
            element.innerHTML = text.substring(0, i + 1);
            setTimeout(() => typeWriter(element, text, i + 1, callback), 100);
        } else {
            setTimeout(() => {
                element.classList.remove('cursor');
                if (callback) setTimeout(callback, 2000);
            }, 1500);
        }
    }

    function eraseText(element, callback) {
        let text = element.innerHTML;
        let i = text.length;
        
        function erase() {
            if (i > 0) {
                element.classList.add('cursor');
                element.innerHTML = text.substring(0, i - 1);
                i--;
                setTimeout(erase, 50);
            } else {
                element.classList.remove('cursor');
                if (callback) setTimeout(callback, 500);
            }
        }
        setTimeout(erase, 1500);
    }

    let messageIndex = 0;
    function animateTypingText() {
        typeWriter(typingText, messages[messageIndex], 0, () => {
            eraseText(typingText, () => {
                messageIndex = (messageIndex + 1) % messages.length;
                animateTypingText();
            });
        });
    }

    // Start the animation
    animateTypingText();

    // Remove old client-side filtering function and implement new AJAX filtering
    async function fetchAndRenderBooks() {
        const categorySelect = document.getElementById('categorySelect');
        const searchInput = document.getElementById('searchInput');
        const selectedCategory = categorySelect ? categorySelect.value : 'all';
        const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';

        try {
            const response = await fetch('/api/books/filter?category=' + encodeURIComponent(selectedCategory) + '&search=' + encodeURIComponent(searchTerm), { credentials: 'include' });
            const data = await response.json();
            if (data.success) {
                const books = data.books;

                const booksContainer = document.getElementById('booksContainer');
                booksContainer.innerHTML = '';

                if (books.length === 0) {
                    booksContainer.innerHTML = '<div class="col-span-4 text-center py-8"><div class="text-gray-500">No books available at the moment.</div></div>';
                    return;
                }

                books.forEach(function(book) {
                    const categorySlug = book.category_name ? book.category_name.toLowerCase().replace(/\s+/g, '-') : 'uncategorized';
                    const isPopular = book.is_popular;
                    const isAvailable = book.is_available;
                    const cover = book.cover ? book.cover : '';
                    const author = book.author ? book.author : 'Unknown Author';
                    const yearPublisher = book.year_publisher ? book.year_publisher : '';
                    const bookId = book.id;
                    const bookName = book.name;

                    let popularBadge = '';
                    if (isPopular) {
                        popularBadge = '<div class="absolute top-2 right-2 bg-yellow-400 text-yellow-900 px-2 py-1 rounded-full text-xs font-semibold">' +
                            '<i class="fas fa-star mr-1"></i> Popular' +
                            '</div>';
                    }

                    let favoriteBtn = '<button data-book-id="' + bookId + '" ' +
                        'class="favorite-btn absolute top-2 left-2 hover:text-red-500 focus:outline-none z-10" ' +
                        'title="Toggle Favorite">' +
                        '<i class="fas fa-heart text-gray-400"></i>' +
                        '</button>';

                    let borrowBtn = '';
                    if (isAvailable) {
                        borrowBtn = '<button data-book-id="' + bookId + '" ' +
                            'data-book-title="' + bookName + '" ' +
                            'class="borrow-btn w-full mt-4 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300">' +
                            '<i class="fas fa-book-reader mr-2"></i> Pinjam Buku' +
                            '</button>';
                    } else {
                        borrowBtn = '<a href="/auth/login" class="block text-center w-full mt-4 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300">' +
                            '<i class="fas fa-sign-in-alt mr-2"></i> Login untuk Meminjam' +
                            '</a>';
                    }

                    const bookCard = document.createElement('div');
                    bookCard.className = 'book-card';
                    bookCard.dataset.category = categorySlug;
                    let coverHtml = '';
                    if (cover) {
                        coverHtml = '<img src="' + cover + '" alt="' + bookName + '" class="w-full h-full object-cover">';
                    } else {
                        coverHtml = '<div class="w-full h-full flex items-center justify-center">' +
                            '<i class="fas fa-book text-5xl text-blue-300"></i>' +
                            '</div>';
                    }
                    bookCard.innerHTML = '<div class="bg-white rounded-lg shadow-lg overflow-hidden transition-all duration-300 relative">' +
                        '<div class="h-48 bg-blue-100 relative">' +
                        coverHtml +
                        popularBadge +
                        favoriteBtn +
                        '</div>' +
                        '<div class="p-6">' +
                        '<div class="text-xs text-blue-600 font-semibold mb-2">' + (book.category_name || 'Uncategorized') + '</div>' +
                        '<h3 class="text-lg font-semibold text-gray-800 mb-2">' + bookName + '</h3>' +
                        '<p class="text-gray-600 text-sm mb-2">' + author + '</p>' +
                        '<div class="flex justify-between items-center mt-4">' +
                        '<span class="text-sm text-gray-500">' + yearPublisher + '</span>' +
                        '<span class="px-2 py-1 rounded-full text-xs ' + (isAvailable ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800') + '">' +
                        (isAvailable ? 'Available' : 'Not Available') +
                        '</span>' +
                        '</div>' +
                        borrowBtn +
                        '</div>' +
                        '</div>';

                    booksContainer.appendChild(bookCard);
                });

                // Re-attach event listeners for borrow and favorite buttons
                attachEventListeners();
            } else {
                showMessage('Failed to fetch books', 'error');
            }
        } catch (error) {
            console.error('Error fetching books:', error);
            showMessage('Error fetching books', 'error');
        }
    }

    // Attach event listeners for borrow and favorite buttons
    function attachEventListeners() {
        // Borrow buttons
        document.querySelectorAll('.borrow-btn').forEach(button => {
            button.addEventListener('click', function() {
                const bookId = this.dataset.bookId;
                const bookTitle = this.dataset.bookTitle;
                openBorrowModal(bookId, bookTitle);
            });
        });

        // Favorite buttons
        document.querySelectorAll('.favorite-btn').forEach(button => {
            button.addEventListener('click', async function(event) {
                event.preventDefault();
                const bookId = this.dataset.bookId || this.getAttribute('data-book-id');
                if (!bookId) return;

                try {
                    const response = await fetch('/dashboard/user/favorite/toggle', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ bookId: parseInt(bookId) }),
                    });
                    const result = await response.json();
                    if (result.success) {
                        const icon = this.querySelector('i.fas.fa-heart');
                        if (result.favorited) {
                            icon.classList.remove('text-gray-400');
                            icon.classList.add('text-red-500');
                            showMessage('Buku berhasil ditambahkan ke favorit', 'success');
                        } else {
                            icon.classList.remove('text-red-500');
                            icon.classList.add('text-gray-400');
                            showMessage('Buku berhasil dihapus dari favorit', 'success');
                        }
                    } else {
                        showMessage(result.error || 'Gagal memperbarui favorit', 'error');
                    }
                } catch (error) {
                    console.error('Error toggling favorite:', error);
                    showMessage('Terjadi kesalahan saat memperbarui favorit', 'error');
                }
            });
        });
    }

    // Event listeners for category select and search input
    document.getElementById('categorySelect')?.addEventListener('change', fetchAndRenderBooks);
    document.getElementById('searchInput')?.addEventListener('input', fetchAndRenderBooks);

    // Initial fetch and render

// Set up borrow button click handlers
document.querySelectorAll('.borrow-btn').forEach(button => {
    button.addEventListener('click', function() {
        const bookId = this.dataset.bookId;
        const bookTitle = this.dataset.bookTitle;
        openBorrowModal(bookId, bookTitle);
    });
});

// Set up favorite button click handlers
document.querySelectorAll('.favorite-btn').forEach(button => {
    button.addEventListener('click', async function(event) {
        event.preventDefault();
        const bookId = this.dataset.bookId || this.getAttribute('data-book-id');
        if (!bookId) return;

        try {
            const response = await fetch('/dashboard/user/favorite/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ bookId: parseInt(bookId) }),
            });
            const result = await response.json();
            if (result.success) {
                const icon = this.querySelector('i.fas.fa-heart');
                if (result.favorited) {
                    icon.classList.remove('text-gray-400');
                    icon.classList.add('text-red-500');
                    showMessage('Buku berhasil ditambahkan ke favorit', 'success');
                } else {
                    icon.classList.remove('text-red-500');
                    icon.classList.add('text-gray-400');
                    showMessage('Buku berhasil dihapus dari favorit', 'success');
                }
            } else {
                showMessage(result.error || 'Gagal memperbarui favorit', 'error');
            }
        } catch (error) {
            console.error('Error toggling favorite:', error);
            showMessage('Terjadi kesalahan saat memperbarui favorit', 'error');
        }
    });
});
});

// Borrow Modal Functions
function openBorrowModal(bookId, bookTitle) {
    document.getElementById('bookId').value = bookId;
    document.getElementById('bookTitle').textContent = bookTitle;
    
    // Set default loan date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('loansDate').value = today;
    
    document.getElementById('borrowModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeBorrowModal() {
    document.getElementById('borrowModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    document.getElementById('borrowForm').reset();
}

// Calculate due date when loan date or duration changes
function calculateDueDate() {
    const loansDate = document.getElementById('loansDate').value;
    const loanDuration = document.getElementById('loanDuration').value;
    
    if (loansDate && loanDuration) {
        const startDate = new Date(loansDate);
        const dueDate = new Date(startDate);
        dueDate.setDate(dueDate.getDate() + parseInt(loanDuration));
        
        const formattedDueDate = dueDate.toISOString().split('T')[0];
        document.getElementById('dueDate').value = formattedDueDate;
    }
}

// Add event listeners for date calculation
document.getElementById('loansDate')?.addEventListener('change', calculateDueDate);
document.getElementById('loanDuration')?.addEventListener('change', calculateDueDate);

// Handle form submission
document.getElementById('borrowForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const bookId = formData.get('book_id');
    const loansDate = formData.get('loans_date');
    const loanDuration = formData.get('loan_duration');
    const dueDate = formData.get('due_date');
    const purpose = formData.get('purpose');
    const agreeTerms = document.getElementById('agreeTerms').checked;
    
    // Validation
    if (!loansDate) {
        showMessage('Silakan pilih tanggal peminjaman', 'error');
        return;
    }
    
    if (!loanDuration) {
        showMessage('Silakan pilih durasi peminjaman', 'error');
        return;
    }
    
    if (!agreeTerms) {
        showMessage('Anda harus menyetujui syarat dan ketentuan', 'error');
        return;
    }
    
    // Validate loan date (not in the past)
    const today = new Date().toISOString().split('T')[0];
    if (loansDate < today) {
        showMessage('Tanggal peminjaman tidak boleh di masa lalu', 'error');
        return;
    }
    
    try {
        const response = await fetch('/loans', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                book_id: parseInt(bookId),
                loans_date: loansDate,
                loan_duration: parseInt(loanDuration),
                due_date: dueDate,
                purpose: purpose || null
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('Buku berhasil dipinjam!', 'success');
            closeBorrowModal();
            // Optionally refresh the page to update book availability
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showMessage(result.error || 'Terjadi kesalahan saat meminjam buku', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage('Terjadi kesalahan saat meminjam buku', 'error');
    }
});

// Show success/error messages
function showMessage(message, type) {
    const messageContainer = document.getElementById('messageContainer');
    const messageDiv = document.createElement('div');
    
    const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
    const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
    
    messageDiv.className = bgColor + ' text-white px-6 py-4 rounded-lg shadow-lg mb-4 transform transition-all duration-300 translate-x-full';
    messageDiv.innerHTML = '<div class="flex items-center">' +
        '<i class="' + icon + ' mr-3"></i>' +
        '<span>' + message + '</span>' +
        '</div>';
    
    messageContainer.appendChild(messageDiv);
    
    // Animate in
    setTimeout(function() {
        messageDiv.classList.remove('translate-x-full');
    }, 100);
    
    // Remove after 5 seconds
    setTimeout(function() {
        messageDiv.classList.add('translate-x-full');
        setTimeout(function() {
            messageContainer.removeChild(messageDiv);
        }, 300);
    }, 5000);
}

// Close modal when clicking outside
document.getElementById('borrowModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeBorrowModal();
    }
});
</script>
